on:
  ##push:
  pull_request:
   types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  init_job:
    outputs:
      output_youtrack_task_id: ${{ steps.step_of_extract_task_id.outputs.youtrack_task_id }}
    runs-on: ubuntu-20.04
    steps:
      - name : Print Title of PR
        run: | 
          echo "The Title of your PR is ${{ github.event.pull_request.title }}"
          echo "The Title of your PR is ${{ github.event.pull_request.body  }}"

      - name: Set env
        run: | 
          echo "TEST=$(echo $GITHUB_SHA | cut -c 1-6)" >> $GITHUB_ENV
          echo "Test0 == ${{ env.TEST }}"
      - name: Get env
        run: echo "Test1 == ${{ env.TEST }}"
      
      - name: Extract task id
        id: step_of_extract_task_id
        env:
          PULL_REQUEST_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "PULL_REQUEST_BODY = ${{ env.PULL_REQUEST_BODY }}"
          #echo "youtrack_task_id=$(echo ${PULL_REQUEST_BODY} | grep -Eo "\[EMAM3MT5-[0-9]+" | cut -c 2-)" >> $GITHUB_OUTPUT
          #echo "TASK_IDS=$(echo ${PULL_REQUEST_BODY} | grep -Eo "\[EMAM3MT5-[0-9]+" | cut -c 2-)" >> $GITHUB_ENV
          ##echo "youtrack_task_id=($(echo ${PULL_REQUEST_BODY} | grep -Eo "\[EMAM3MT5-[0-9]+" | cut -c 2-))" >> $GITHUB_OUTPUT
          ##echo "TASK_IDS=($(echo ${PULL_REQUEST_BODY} | grep -Eo "\[EMAM3MT5-[0-9]+" | cut -c 2-))" >> $GITHUB_ENV
          
          #TASK_IDS=($(echo ${PULL_REQUEST_BODY} | grep -Eo "\[EMAM3MT5-[0-9]+" | cut -c 2-))
          TASK_IDS="$(echo ${PULL_REQUEST_BODY} | grep -Eo "\[EMAM3MT5-[0-9]+" | cut -c 2-)"
          echo TASK_IDS=$TASK_IDS >> $GITHUB_ENV
          echo $TASK_IDS
#--------------------------------------------------------------------
      - name: Get SHARED Pull Requests
        uses: octokit/request-action@v2.x
        id: get_shared_prs
        with:
          route: GET /repos/{owner}/{repo}/pulls
          owner: TakeprofitTechnology
          repo: Shared
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - name: Get TASK_IDS env
        run: echo "TASK_IDS == ${{ env.TASK_IDS }}"

      - name: Get TASK_IDS env
        run: |
          TASK_IDS=(${TASK_IDS[@]})
            for i in "${TASK_IDS[@]}"; do
              echo "i = $i";
          done

      - name: Set SHARED refs
        env:
          SHARED_PRS: ${{ steps.get_shared_prs.outputs.data }}
        run: |
          #TASK_IDS=(${TASK_IDS[@]})
          for i in "${TASK_IDS[@]}"; do
            tmp=$(echo $SHARED_PRS | jq -r --arg task_id "$i" '[.[] | select(.body!=null and (.body | contains($task_id))) | .number][0]')
            if [[ "$tmp" != "null" ]]; then SHARED_REF="$tmp"; fi
          done
          [[ $SHARED_REF ]] && SHARED_REF="refs/pull/${SHARED_REF}/merge" || SHARED_REF="refs/heads/master"
          echo SHARED_REF=$SHARED_REF >> $GITHUB_ENV
          
      - name: Get SHARED env
        run: echo "SHARED_REF == ${{ env.SHARED_REF }}"
#--------------------------------------------------------------------



  print_title_of_pr:
    runs-on: windows-latest
    needs: init_job
    steps:
    - name : Print Outputs
      run: echo "output_youtrack_task_id = ${{needs.init_job.outputs.output_youtrack_task_id}} "    
